<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Roost</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    #icon-picker {
      position: absolute;
      top: 10px;
      left: 10px;
      background: black;
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
    }
    #icon-picker img {
      cursor: pointer;
      opacity: 0.5;
      margin: 2px;
    }
    #icon-picker img.selected {
      opacity: 1;
      border: 2px solid #fff;
      border-radius: 6px;
    }
    #search {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="icon-picker">
    <span style="color:white;">Select:</span><br/>
    <img src="icons/gotnumber.png" width="40" data-type="gotnumber" class="selected">
    <img src="icons/kissed.png" width="40" data-type="kissed">
    <img src="icons/carhookup.png" width="40" data-type="carhookup">
    <img src="icons/tookhome.png" width="40" data-type="tookhome">
    <img src="icons/breakfast.png" width="40" data-type="breakfast">
    <img src="icons/goback.png" width="40" data-type="goback">
    <img src="icons/placerocked.png" width="40" data-type="placerocked">
  </div>
  <div id="search">
    <input type="text" id="locationInput" placeholder="Enter ZIP or place" />
    <button onclick="zoomToLocation()">Go</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuxzbdg90g5Ih-kkwqTkJBYyiseaZ1yx0",
      authDomain: "cocker-59baa.firebaseapp.com",
      projectId: "cocker-59baa",
      storageBucket: "cocker-59baa.firebasestorage.app",
      messagingSenderId: "336923549983",
      appId: "1:336923549983:web:f6b18fbda5ab290fc3d02a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const map = L.map('map').setView([37.0902, -95.7129], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let selectedEncounter = "gotnumber";

    document.querySelectorAll('#icon-picker img').forEach(img => {
      img.addEventListener('click', () => {
        selectedEncounter = img.dataset.type;
        document.querySelectorAll('#icon-picker img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      });
    });

    onSnapshot(collection(db, "markers"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const data = change.doc.data();
          L.marker([data.lat, data.lng])
            .addTo(map)
            .bindPopup(\`<strong>\${data.user || 'Anonymous'}</strong><br/><img src="icons/\${data.encounter}.png" width="48">`);
        }
      });
    });

    map.on('click', async (e) => {
      const { lat, lng } = e.latlng;
      await addDoc(collection(db, "markers"), {
        lat, lng,
        encounter: selectedEncounter,
        user: "Guest",
        timestamp: Date.now()
      });
    });

    window.zoomToLocation = function() {
      const query = document.getElementById("locationInput").value;
      if (!query) return;
      fetch(\`https://nominatim.openstreetmap.org/search?format=json&q=\${query}\`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const { lat, lon } = data[0];
            map.setView([parseFloat(lat), parseFloat(lon)], 14);
          } else {
            alert("Location not found.");
          }
        });
    };
  </script>
</body>
</html>
